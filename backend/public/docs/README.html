
<!doctype html>
<html lang="en">
  <head>
    <title>README</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.classless.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/dracula/highlightjs/dracula.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style> pre>code.hljs {padding: var(--spacing); color: rgb(162, 175, 185);} blockquote p {margin-bottom: 0;}</style>
    <script>hljs.highlightAll();</script>
  </head>
  <body>
    <main>
    <!-- markdownlint-disable MD033 -->
<h1 id="pokemoncardbattletcg">Pokemon Card Battle TCG</h1>
<p>This backend application consist of a REST API which exposes the ðŸ‘‰
<a href="#endpoints"><em>endpoints</em></a> documented by Swagger at
<a href="http://localhost:3004/docs"> <code class="prettyprint">APP_HOST:APP_PORT/docs</code></a> path. See the
<a href="#swagger">Swagger</a> section for more details.</p>
<h2 id="environment">Environment</h2>
<p>This aplication is created using Node.js v20. It is recommended using
<strong><a href="https://github.com/creationix/nvm">nvm</a></strong> (Node Version Manager) to manage
Node.js versions. Go to
<a href="https://github.com/creationix/nvm">github.com/creationix/nvm</a> and check the
installation process for your OS.</p>
<p>Make sure to set the env variables. For local environment you can create a <code class="prettyprint">.env</code> file with the following environment variables:</p>
<pre class="prettyprint linenums"><code class="bash language-bash"># dev | prod | test
NODE_ENV=dev
APP_HOST=localhost
APP_PORT=3004

# Authentication
JWT_SECRET=SOME-SECRET-HASH
JWT_EXPIRE=86400
</code></pre>
<blockquote>
  <p>ðŸ’¡ In order to set the value for <code class="prettyprint">JWT_SECRET</code>, you can run the
  <code class="prettyprint">npm run secret</code> script, and copy the generated hash.</p>
  <p>ðŸ’¡ This project uses more env variables. Please go to the <a href="#docker">Docker</a>
  section to set up the environment variables for Postgres and PG Admin.</p>
</blockquote>
<h2 id="runningtheserver">Running the server</h2>
<p>Install required dependencies:</p>
<pre class="prettyprint linenums"><code class="bash language-bash">npm install
</code></pre>
<p>After all dependencies are installed, just run the commands below:</p>
<pre class="prettyprint linenums"><code class="bash language-bash">npm run db:up # to start the database (docker)
npm run db:migrate # initializes the database
npm run swagger # to generate server routes
npm run dev:server
</code></pre>
<h2 id="scripts">Scripts</h2>
<ul>
<li> <code class="prettyprint">npm run dev:server</code> - Starts the server in development mode (watch mode).</li>
<li> <code class="prettyprint">npm run swagger</code> - Generates server routes and swagger documentation.</li>
<li> <code class="prettyprint">npm run db:up</code> - Starts the database (docker).</li>
<li> <code class="prettyprint">npm run db:create</code> - Creates the Database using sequelize.</li>
<li> <code class="prettyprint">npm run db:migrate</code> - Perform migrations using sequelize.</li>
<li> <code class="prettyprint">npm run build-all</code>- Builds the project in production mode.</li>
<li> <code class="prettyprint">npm run secret</code> - Generates a hash used by <code class="prettyprint">JWT_SECRET</code></li>
<li> <code class="prettyprint">npm run start</code> - Starts the server (compiled).</li>
<li> <code class="prettyprint">npm run test</code> - Runs all tests.</li>
</ul>
<h2 id="endpoints">Endpoints</h2>
<p>The following endpoints are exposed by Express:</p>
<ul>
<li> <code class="prettyprint">/login</code> Generates a new JWToken to authenticate users consuming the API.</li>
<li>In order to generate a JWToken, you need to set the env variable <code class="prettyprint">JWT_SECRET</code> first. You can run the <code class="prettyprint">npm run secret</code> script and copy the
generated hash.</li>
<li> <code class="prettyprint">/swagger</code> Swagger documentation.</li>
<li> <code class="prettyprint">/docs</code> Swagger documentation.</li>
</ul>
<h2 id="swagger">Swagger</h2>
<p>This projects uses
<a href="https://tsoa-community.github.io/docs/getting-started.html">tsoa</a> along with <code class="prettyprint">swagger-ui-express</code> to generate the documentation. The folder <code class="prettyprint">src/swagger</code>
contains files autogenerated by <code class="prettyprint">tsoa</code>, that includes routes and swagger spec
files specified in <a href="./tsoa.json">tsoa.json</a>. The server uses <code class="prettyprint">['/docs', '/openapi', '/swagger']</code> routes to deliver static content with the
API documentation generated by <code class="prettyprint">tsoa</code>.</p>
<h2 id="docker">Docker</h2>
<p>MongoDB is loaded as a docker container, sou you need to make sure to create a <code class="prettyprint">.env</code> file with the following environment variables:</p>
<pre class="prettyprint linenums"><code class="bash language-bash">POSTGRES_USER=appuser
POSTGRES_PASSWORD=symfony
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=pokemon

PGADMIN_DEFAULT_EMAIL=pgadmin4@pgadmin.org
PGADMIN_DEFAULT_PASSWORD=admin
PGADMIN_PORT=5050
</code></pre>
<p>In order to run Postgres, you need to mount the docker container, and start the <code class="prettyprint">psql</code> service. To do that just run the command:</p>
<pre class="prettyprint linenums"><code class="bash language-bash">npm run db:up
</code></pre>
<p>After that, let's make sure the container is running:</p>
<pre class="prettyprint linenums"><code class="bash language-bash">docker ps -a
</code></pre>
<p>You should have a result like this:</p>
<pre class="prettyprint linenums"><code class="bash language-bash">CONTAINER ID   IMAGE             COMMAND                  CREATED      STATUS        PORTS                    NAMES
369fec1a41d2   dpage/pgadmin4    "/entrypoint.sh"         1 hour ago   Up 2 minutes  0.0.0.0:5050-&gt;80/tcp     pgadmin_4
879b90b32d08   postgres:114.12   "docker-entrypoint.sâ€¦"   1 hour ago   Up 2 minutes  0.0.0.0:5432-&gt;5432/tcp   postgresdb_14
</code></pre>
<p>To open
<a href="https://anasdidi.dev/articles/200713-docker-compose-postgres/">PG Admin</a>, the
web-based Postgres admin interface, go to the browser and navigate to <code class="prettyprint">http://localhost:5050/</code>, using credentials in the env variables <code class="prettyprint">PGADMIN_DEFAULT_EMAIL</code> and <code class="prettyprint">PGADMIN_DEFAULT_PASSWORD</code>.</p>
<ul>
<li>Click on <code class="prettyprint">Add New Server</code></li>
<li>Click on <code class="prettyprint">Connection</code> tab, and put <code class="prettyprint">postgresmon</code> as the Host name, which is
the database service name in the <code class="prettyprint">docker-compose.yml</code> file.</li>
<li>Alternatively, you can use the docker container public IP . Just execute: <code class="prettyprint">docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' postgresdb_14</code></li>
<li>Put the <strong>username</strong> and <strong>password</strong> specified in the env variables <code class="prettyprint">POSTGRES_USER</code> and <code class="prettyprint">POSTGRES_PASSWORD</code> respectively.</li>
</ul>
<p>If you want to open the terminal to run commands on the container, just run the
following command for the specific container:</p>
<pre class="prettyprint linenums"><code class="bash language-bash">docker exec -it postgresdb_14 bash
root@postgresmon:/#
</code></pre>
<p>For example, we can get the list of databases by running:</p>
<pre class="prettyprint linenums"><code class="bash language-bash"># psql -h {HOST} -p {PORT} -U {USER} -l
psql -h localhost -p 5432 -U appuser -l
</code></pre>
<p>And we get the following results:</p>
<pre class="prettyprint linenums"><code class="bash language-bash">                               List of databases
   Name    |  Owner  | Encoding |  Collate   |   Ctype    |  Access privileges
-----------+---------+----------+------------+------------+---------------------
 pokemon   | appuser | UTF8     | en_US.utf8 | en_US.utf8 |
 postgres  | appuser | UTF8     | en_US.utf8 | en_US.utf8 |
 template0 | appuser | UTF8     | en_US.utf8 | en_US.utf8 | =c/appuser         +
           |         |          |            |            | appuser=CTc/appuser
 template1 | appuser | UTF8     | en_US.utf8 | en_US.utf8 | =c/appuser         +
           |         |          |            |            | appuser=CTc/appuser
</code></pre>
    </main>
  </body>
</html>